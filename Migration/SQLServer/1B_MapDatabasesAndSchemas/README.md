
# **Module 1B_MapDatabasesAndSchemas** 

Use module **1B_MapDatabasesAndSchemas** to replace schema names in DDL scripts generated by module **1A_ExtractCodeDDLs**. This may be required when consolidating multiple source databases into a single Azure Synapse Dedicated SQL Pool to avoid conflicts in objects naming.

The PowerShell script performs the following changes in DDL scripts:

- Adds default schema name if schema name is missing in object references
- Replaces schema names according to schema mapping
- Identifies if unsupported data types are used and adds a summary in case of any unsupported data types found.

> ##### Disclaimer
>
> This script does not produce the code which is 100% syntactically correct and ready for deployment in Azure Synapse Dedicated SQL Pool. The script only aids mentioned above activities and provides information about the usage of unsupported data types.



##### Attention

The script does not convert the following features which are not supported in Azure Synapse. The code which uses these features should be converted manually.

- Default parameter values in stored procedures
- Common Table Expressions (CTE)
- Cursors
- Triggers
- Change Data Capture (CDC)
- Change Tracking (CT)
- MSDB objects (jobs, operators, schedules, etc.)
- User Defined Data Types
- Table data type in Table Valued Functions
- FILESTREAM
- GETDATE() function which returns date and time in UTC time zone in Azure 
- ...



You need to run **MapDatabasesAndSchemas.ps1** script which will prompt you for the following configuration information:

1. **cs_dirs.csv** - this CSV file specifies the list of directories where source DDL scripts are located.
2. **schemas.csv** - this CSV file defines source-to-target schema mapping.
3. **Do you want to use 3-part names?** If YES then the script will generate 3-part names for all object references. This may be useful for cross-database queries (* expected to be available in Azure Synapse Gen3).
4. **Do you want to add missing schemas?** If YES then default schema name will be added to object references where schema name is omitted. This may be useful when migrating multiple databases and schemas to make object references more explicit and readable.

> ##### **Note**
>
> Configuration files are expected to be in the same folder where PowerShell script resides.

The definition and sample values for each column in **cs_dirs.csv** file are described in below table:

| Column             | Description                                                  | Sample Values                                                |
| ------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| Active             | 1 – Use record,  0 – Skip record.                            | 0 or 1                                                       |
| SourceDatabaseName | The name of source database                                  | AdventureWorks2019                                           |
| SourceDirectory    | The directory where source DDL scripts are located.<br />*Both absolute and relative paths are supported. Script folder is assumed as base path.* | ..\Output\1A_ExtractCodeDDLs<br />\AdventureWorksDW2019\Views |
| TargetDirectory    | The directory where converted DDL scripts will be stored.<br />*Both absolute and relative paths are supported. Script folder is assumed as base path.* | ..\Output\1B_MapDatabasesAndSchemas\<br />\AdventureWorksDW2019\Views |
| DefaultSchema      | Default schema name which will be assume if schema name is omitted in object reference. | dbo                                                          |
| ObjectType         | The type of objects for the source directory                 | Function<br />SP<br />View                                   |

The definition and sample values for each column in **schemas.csv** is described in below table:

| Column         | Description                                                  | Sample Values        |
| -------------- | ------------------------------------------------------------ | -------------------- |
| SourceDatabase | The name of source database                                  | AdventureWorksDW2019 |
| SourceSchema   | The name of schema in source database                        | dbo                  |
| TargetDatabase | The name of target database (Azure Synapse Dedicated SQL pool) | EDW                  |
| TargetSchema   | The name of schema in target database                        | adw                  |

Sample script output is depicted below.

![](..\\images\M1B_ScriptOutput.JPG)

Extracted DDL scripts will be stored under Output folder and structured by respective database name and object type (View, Functions, Stored Procedures, Triggers).

![](..\\images\M1B_OutputFolder.JPG)

![](..\\images\M1B_SampleFolder.JPG)

When found any unsupported data types, PowerShell script adds summary comment at the beginning of converted DDL scripts.

```sql
/*
	Total # of occurences of unsupported data types found - 5
	geometry        - 0
	geography       - 0
	hierarchyid     - 1 (lines - 4)
	image           - 0
	ntext           - 0
	text            - 0
	sql_variant     - 0
	timestamp       - 1 (lines - 122)
	xml             - 3 (lines - 10, 21, 22)
*/
```



#### **Important notes**

- PowerShell script requires PowerShell version 5.1 or higher and **SqlServer** module. If these prerequsites are not met the script will fail immediately and report missing prerequisites.
- Configuration files are expected in the same folder where the script is located.
- As DDL scripts are processed using regular expressions it may take considerable time to process large scripts.
- If output folder is not empty existing files will be overwritten in case of file name match.
- DDL scripts are analyzed as text, i.e. actual code and comments are not separated. Hence, comments may be changed.

